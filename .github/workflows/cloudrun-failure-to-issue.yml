name: Cloud Run Failure To Issue

on:
  workflow_run:
    workflows: ["Deploy Nakama To Cloud Run"]
    types: [completed]

permissions:
  actions: read
  contents: read
  issues: write

jobs:
  open_issue:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    steps:
      - name: Create triage issue
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;
            const shortSha = (run.head_sha || "").slice(0, 7) || "unknown";
            const title = `ðŸš¨ cloud run deploy failed: ${run.name} ${shortSha}`;
            const runUrl = run.html_url;
            const refName = run.head_branch || run.head_sha || "unknown";
            const targetHint = run.head_branch === "main" ? "staging" : "prod-or-manual";

            const { data: existing } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              per_page: 100
            });
            const duplicate = existing.find((issue) => issue.title === title);
            if (duplicate) {
              core.info(`Issue already open: #${duplicate.number}`);
              return;
            }

            const desiredLabels = ["incident", "ci", "deploy", "sev:P1", "status:triage", "agent:devops"];
            const repoLabels = await github.paginate(github.rest.issues.listLabelsForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            const repoLabelNames = new Set(repoLabels.map((label) => label.name));
            const labels = desiredLabels.filter((name) => repoLabelNames.has(name));

            const body = [
              "Cloud Run deployment failed.",
              "",
              `- Workflow: ${run.name}`,
              `- Run URL: ${runUrl}`,
              `- SHA: ${run.head_sha || "unknown"}`,
              `- Ref: ${refName}`,
              `- Target hint: ${targetHint}`,
              "",
              "Owner: DevOps",
              "",
              "Checklist:",
              "- [ ] Capture first failing step + error message",
              "- [ ] Confirm secrets/vars for target environment",
              "- [ ] Confirm Artifact Registry image exists",
              "- [ ] Verify Cloud Run revision and service health",
              "- [ ] Add root cause + prevention note before closing"
            ].join("\n");

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels
            });
